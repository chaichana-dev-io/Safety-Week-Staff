<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>STAFF PORTAL 2026</title>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&family=Inter:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <style>
    :root { --navy: #1a237e; --blue-light: #3b82f6; --bg-gray: #f4f7fe; }
    body { font-family: 'Kanit', sans-serif; background-color: var(--bg-gray); }
    .header-section { background: var(--navy); color: white; padding: 40px 0 80px 0; text-align: center; }
    .nav-container { margin-top: -45px; display: flex; justify-content: center; }
    .nav-pills { background: white; padding: 8px; border-radius: 50px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
    .nav-pills .nav-link { border-radius: 40px; color: #666; padding: 12px 25px; font-weight: 600; border: none; }
    .nav-pills .nav-link.active { background-color: var(--navy) !important; color: white !important; }
    .main-card { border-radius: 35px; border: none; box-shadow: 0 15px 45px rgba(0,0,0,0.05); background: white; margin-top: 30px; }
    .stat-box { background: white; border-radius: 25px; padding: 15px; border: 1px solid #edf2f7; text-align: center; }
    .stat-value { font-size: 1.8rem; font-weight: 700; color: var(--navy); font-family: 'Inter'; }
    .progress-circle { width: 120px; height: 120px; border-radius: 50%; background: conic-gradient(var(--blue-light) var(--p), #edf2f7 0); display: flex; align-items: center; justify-content: center; margin: 20px auto; position: relative; }
    .progress-circle::before { content: ""; position: absolute; width: 100px; height: 100px; background: white; border-radius: 50%; }
    .progress-text { position: relative; font-size: 1.2rem; font-weight: 700; }
    .next-base-pill { background: #e2f9e1; color: #2d6a4f; padding: 10px 25px; border-radius: 15px; font-weight: 600; display: inline-block; }
    .input-group-custom { background: #fff; border: 1px solid #e2e8f0; border-radius: 20px; padding: 5px 5px 5px 20px; display: flex; align-items: center; }
    .input-group-custom input { border: none; outline: none; width: 100%; font-size: 1.1rem; }
    .btn-action { background: var(--blue-light); color: white; border-radius: 15px; padding: 12px 30px; border: none; font-weight: 600; }
    .mode-card { cursor: pointer; transition: 0.2s; }
    .active-mode { border: 2px solid var(--blue-light) !important; background-color: #f0f7ff !important; }
    #canvas { width: 100%; border-radius: 20px; display: none; background: #000; }
    .locked { opacity: 0.4; pointer-events: none; filter: grayscale(1); }
    .modal-content { border-radius: 30px; border: none; }
    .table-aaa tr { cursor: pointer; }
    .table-aaa tr:hover { background-color: #f8f9fa; }
  </style>
</head>
<body>

  <script>const API_URL = "https://script.google.com/macros/s/AKfycbyM1HtJEAG3qSCHPiX4diy9D_fZRjUa6dCcFgZCWa0j3qRLNJvu4nalzPgkDJANzoNn/exec";</script>

  <div class="header-section">
    <h2>STAFF PORTAL</h2>
    <p>Management Dashboard 2026</p>
  </div>

  <div class="container">
    <div class="nav-container">
      <ul class="nav nav-pills" id="staffTabs">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#recordTab" onclick="resetAll()"><i class="bi bi-qr-code-scan me-2"></i>บันทึกเวลา</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#monitorTab" onclick="updateStats(); resetAll();"><i class="bi bi-grid-3x3-gap me-2"></i>Monitor</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#editTab" onclick="resetEdit(); resetAll();"><i class="bi bi-pencil-square me-2"></i>แก้ไข</button></li>
      </ul>
    </div>

    <div class="tab-content pb-5">
      <div class="tab-pane fade show active" id="recordTab">
        <div class="card main-card p-4">
          <div class="row g-3 mb-4 text-center">
            <div class="col-6"><div id="btnIn" class="mode-card border p-4 rounded-4" onclick="setMode('checkin')"><i class="bi bi-box-arrow-in-right fs-1 text-primary"></i><div class="mt-2 fw-bold">CHECK-IN</div></div></div>
            <div class="col-6"><div id="btnOut" class="mode-card border p-4 rounded-4" onclick="setMode('checkout')"><i class="bi bi-box-arrow-left fs-1 text-primary"></i><div class="mt-2 fw-bold">CHECK-OUT</div></div></div>
          </div>
          <div id="recordAction" class="locked text-center">
            <canvas id="canvas" class="mb-3"></canvas>
            <button id="scanBtn" class="btn btn-action w-100 mb-2" onclick="startCamera()">เปิดกล้องสแกน</button>
            <button id="stopBtn" class="btn btn-danger w-100 mb-3 rounded-4" style="display:none;" onclick="stopCamera()">ยกเลิกการสแกน</button>
            <div class="input-group-custom">
              <input type="text" id="recordId" placeholder="รหัสพนักงาน" autocomplete="off" spellcheck="false">
              <button id="recordSubmitBtn" class="btn-action bg-dark" onclick="submitRecord()">บันทึก</button>
            </div>
          </div>
        </div>
      </div>

      <div class="tab-pane fade" id="monitorTab">
        <div class="row row-cols-3 g-2 mt-2" id="statGrid"></div>
        <div class="card main-card p-4">
          <div class="input-group-custom mb-4">
            <input type="text" id="monId" placeholder="รหัสพนักงาน" autocomplete="off" spellcheck="false">
            <button id="monBtn" class="btn-action" onclick="getMonitor()">ค้นหา</button>
          </div>
          <div id="monResult"></div>
        </div>
      </div>

      <div class="tab-pane fade" id="editTab">
        <div class="card main-card p-4">
          <div id="searchBox" class="input-group-custom mb-3">
            <input type="text" id="editId" placeholder="ค้นหารหัสพนักงาน" autocomplete="off" spellcheck="false">
            <button id="editSearchBtn" class="btn-action" onclick="searchUser()">ค้นหา</button>
          </div>
          <div id="editForm" class="d-none">
            <input type="hidden" id="rowNum">
            <div class="mb-3"><label class="small text-muted">ชื่อ-นามสกุล</label><input type="text" id="nameBox" class="form-control rounded-3 border-0 bg-light p-3" autocomplete="off"></div>
            <div class="row mb-3">
              <div class="col-6"><label class="small text-muted">แผนก</label><input type="text" id="deptBox" class="form-control rounded-3 border-0 bg-light p-3" autocomplete="off"></div>
              <div class="col-6"><label class="small text-muted">ฝ่าย</label><input type="text" id="sectBox" class="form-control rounded-3 border-0 bg-light p-3" autocomplete="off"></div>
            </div>
            <div class="mb-4"><label class="small text-muted">อีเมล</label><input type="email" id="emailBox" class="form-control rounded-3 border-0 bg-light p-3" autocomplete="off"></div>
            <button id="editSaveBtn" class="btn btn-action w-100" onclick="saveEdit()">บันทึกข้อมูล</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="infoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content shadow-lg">
        <div class="modal-body p-5 text-center" id="modalContent"></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    let video = document.createElement("video");
    let canvas = document.getElementById("canvas").getContext("2d");
    let currentMode = null, scanning = false;
    let infoModal = new bootstrap.Modal(document.getElementById('infoModal'));

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        const active = document.querySelector('.tab-pane.active').id;
        if (active === 'recordTab') submitRecord();
        if (active === 'monitorTab') getMonitor();
        if (active === 'editTab') document.getElementById('editForm').classList.contains('d-none') ? searchUser() : saveEdit();
      }
      if (e.key === 'Escape') { infoModal.hide(); resetAll(); }
    });

    async function getMonitor(tid = null) {
      let id = tid || document.getElementById('monId').value.trim();
      if (!id) return;
      Swal.fire({ title: 'กำลังค้นหา...', didOpen: () => Swal.showLoading() });
      const r = await callAPI({ action: 'monitor', id: id }, 'monBtn');
      Swal.close();
      if (!r) return Swal.fire('Error', 'ไม่พบข้อมูล', 'warning');

      if (r.type === 'AAA') {
        let h = '<table class="table table-aaa small"><thead><tr><th>ชื่อ-นามสกุล</th><th class="text-end">ฐาน</th></tr></thead><tbody>' + 
                r.list.map(p => `<tr onclick="getMonitor('${p.id}')"><td>${p.name}<br><small class="text-muted">${p.id}</small></td><td class="text-end fw-bold text-primary">${p.progress}/9</td></tr>`).join('') + 
                '</tbody></table>';
        document.getElementById('monResult').innerHTML = h;
        document.getElementById('monId').value = '';
      } else {
        let h = `<h4 class="fw-bold mb-4">${r.name}</h4><div class="progress-circle" style="--p:${Math.round(r.progress/r.total*100)}%"><div class="progress-text">${r.progress}/${r.total}</div></div><div class="next-base-pill mt-3">สถานีถัดไป: ${r.nextBase}</div><div class="mt-4 small text-muted">กด ESC หรือคลิกด้านนอกเพื่อปิด</div>`;
        if (tid) { 
          document.getElementById('modalContent').innerHTML = h; 
          infoModal.show(); 
        } else { 
          document.getElementById('monResult').innerHTML = h; 
        }
        document.getElementById('monId').value = ''; 
        document.getElementById('monId').focus();
      }
    }

    function setMode(m){currentMode=m;document.getElementById('btnIn').className='mode-card border p-4 rounded-4'+(m==='checkin'?' active-mode':'');document.getElementById('btnOut').className='mode-card border p-4 rounded-4'+(m==='checkout'?' active-mode':'');document.getElementById('recordAction').classList.remove('locked');document.getElementById('recordId').value='';document.getElementById('recordId').focus();}
    async function startCamera(){try{const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});scanning=true;video.srcObject=s;video.play();document.getElementById('canvas').style.display='block';document.getElementById('scanBtn').style.display='none';document.getElementById('stopBtn').style.display='block';requestAnimationFrame(tick);}catch(e){}}
    function stopCamera(){scanning=false;if(video.srcObject)video.srcObject.getTracks().forEach(t=>t.stop());document.getElementById('canvas').style.display='none';document.getElementById('scanBtn').style.display='block';document.getElementById('stopBtn').style.display='none';}
    function tick(){if(video.readyState===video.HAVE_ENOUGH_DATA&&scanning){let el=document.getElementById('canvas');el.height=video.videoHeight;el.width=video.videoWidth;canvas.drawImage(video,0,0,el.width,el.height);let c=jsQR(canvas.getImageData(0,0,el.width,el.height).data,el.width,el.height);if(c){document.getElementById('recordId').value=c.data;stopCamera();submitRecord();}}if(scanning)requestAnimationFrame(tick);}
    async function callAPI(p,b){const btn=document.getElementById(b);btn.disabled=true;btn.innerHTML='<span class="spinner-border spinner-border-sm"></span>';try{const res=await fetch(API_URL,{method:'POST',body:JSON.stringify(p)});btn.disabled=false;btn.innerHTML=b==='recordSubmitBtn'?'บันทึก':'ค้นหา';return await res.json();}catch(e){btn.disabled=false;return null;}}
    async function submitRecord(){let id=document.getElementById('recordId').value.trim();if(!id||!currentMode) return;const r=await callAPI({action:'staffAction',id:id,type:currentMode},'recordSubmitBtn');Swal.fire({icon:r.success?'success':'error',title:r.msg,timer:2000,showConfirmButton:false});document.getElementById('recordId').value='';document.getElementById('recordId').focus();}
    async function updateStats(){const res=await fetch(`${API_URL}?action=getStats`);const s=await res.json();let h='';for(let i=1;i<=9;i++)h+=`<div class="col"><div class="stat-box"><div class="small text-muted">ฐาน ${i}</div><div class="stat-value">${s["Base"+i]||0}</div></div></div>`;document.getElementById('statGrid').innerHTML=h;}
    async function searchUser(){const r=await callAPI({action:'searchUser',id:document.getElementById('editId').value},'editSearchBtn');if(r){['rowNum','nameBox','deptBox','sectBox','emailBox'].forEach((k,i)=>document.getElementById(k).value=Object.values(r)[i]);document.getElementById('searchBox').classList.add('d-none');document.getElementById('editForm').classList.remove('d-none');document.getElementById('editId').value='';}else{Swal.fire('ไม่พบรายชื่อ','','warning');}}
    async function saveEdit(){const d={row:document.getElementById('rowNum').value,name:document.getElementById('nameBox').value,dept:document.getElementById('deptBox').value,sect:document.getElementById('sectBox').value,email:document.getElementById('emailBox').value};const r=await callAPI({action:'updateUser',formData:d},'editSaveBtn');if(r.success){Swal.fire('สำเร็จ','บันทึกแล้ว','success');resetEdit();}}
    function resetEdit(){document.getElementById('searchBox').classList.remove('d-none');document.getElementById('editForm').classList.add('d-none');document.getElementById('editId').value='';document.getElementById('editId').focus();}
    function resetAll(){stopCamera();document.getElementById('monResult').innerHTML='';document.getElementById('recordId').value='';document.getElementById('monId').value='';document.getElementById('editId').value=''; const activeTab = document.querySelector('.tab-pane.active').id; if(activeTab === 'recordTab') document.getElementById('recordId').focus(); if(activeTab === 'monitorTab') document.getElementById('monId').focus(); if(activeTab === 'editTab') document.getElementById('editId').focus();}
  </script>
</body>
</html>
