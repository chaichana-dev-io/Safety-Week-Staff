<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>STAFF PORTAL 2026</title>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&family=Inter:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <style>
    :root { --navy: #1a237e; --blue-light: #3b82f6; --red-out: #dc3545; --bg-gray: #f4f7fe; }
    body { font-family: 'Kanit', sans-serif; background-color: var(--bg-gray); overflow-x: hidden; }
    
    .header-section { background: var(--navy); color: white; padding: 30px 0 70px 0; text-align: center; }
    .nav-container { margin-top: -40px; display: flex; justify-content: center; padding: 0 15px; }
    .nav-pills { background: white; padding: 5px; border-radius: 50px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); display: flex; width: 100%; max-width: 450px; }
    .nav-pills .nav-item { flex: 1; }
    .nav-pills .nav-link { border-radius: 40px; color: #666; padding: 10px 5px; font-weight: 600; font-size: 0.85rem; border: none; display: flex; flex-direction: column; align-items: center; width: 100%; }
    .nav-pills .nav-link.active { background-color: var(--navy) !important; color: white !important; }

    /* Fix: เพิ่มความแรงของ Selector เพื่อให้สีแดงแสดงผลได้ชัวร์ */
    .main-card { border-radius: 30px; border: 4px solid transparent !important; box-shadow: 0 15px 40px rgba(0,0,0,0.05); background: white; margin-top: 25px; transition: all 0.3s ease; }
    
    /* สีกรอบ */
    .border-blue { border-color: var(--blue-light) !important; }
    .border-red { border-color: var(--red-out) !important; }

    /* ปุ่มเลือกโหมด */
    .mode-card { cursor: pointer; transition: 0.2s; border: 2px solid #edf2f7; border-radius: 20px; background: white; text-align: center; }
    .active-in { border-color: var(--blue-light) !important; background-color: #f0f7ff !important; }
    .active-out { border-color: var(--red-out) !important; background-color: #fff5f5 !important; }

    .input-group-custom { background: #fff; border: 1px solid #e2e8f0; border-radius: 20px; padding: 5px 5px 5px 20px; display: flex; align-items: center; }
    .input-group-custom input { border: none; outline: none; width: 100%; font-size: 1.1rem; }
    .btn-action { background: var(--blue-light); color: white; border-radius: 15px; padding: 12px 25px; border: none; font-weight: 600; }
    
    #canvas { width: 100%; border-radius: 20px; display: none; background: #000; margin-bottom: 10px; }
    .locked { opacity: 0.3; pointer-events: none; filter: grayscale(1); }
  </style>
</head>
<body>

  <script>const API_URL = "https://script.google.com/macros/s/AKfycbzD0uVtGiWYcyYhHYPBdksCxbgqlO1YBM7ALzH2LxKCNQfzJ-9VmCywby8yh8OGo1Je/exec";</script>

  <div class="header-section">
    <h3 class="fw-bold">STAFF PORTAL</h3>
    <p class="small opacity-75">Safety Week 2026</p>
  </div>

  <div class="container">
    <div class="nav-container">
      <ul class="nav nav-pills" id="staffTabs">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tabRec" onclick="resetAll()"><i class="bi bi-qr-code-scan"></i><span>บันทึก</span></button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tabMon" onclick="updateStats(); resetAll();"><i class="bi bi-grid-3x3-gap"></i><span>Monitor</span></button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tabEdit" onclick="resetEdit(); resetAll();"><i class="bi bi-pencil-square"></i><span>แก้ไข</span></button></li>
      </ul>
    </div>

    <div class="tab-content pb-5">
      <div class="tab-pane fade show active" id="tabRec">
        <div class="card main-card p-4" id="ui-frame">
          <div class="row g-2 mb-4">
            <div class="col-6">
              <div id="btn-checkin" class="mode-card p-3" onclick="setMode('checkin')">
                <i class="bi bi-box-arrow-in-right fs-2 text-primary"></i>
                <div class="mt-1 fw-bold small">CHECK-IN</div>
              </div>
            </div>
            <div class="col-6">
              <div id="btn-checkout" class="mode-card p-3" onclick="setMode('checkout')">
                <i class="bi bi-box-arrow-left fs-2 text-danger"></i>
                <div class="mt-1 fw-bold small">CHECK-OUT</div>
              </div>
            </div>
          </div>
          <div id="recordAction" class="locked text-center">
            <button id="stopBtn" class="btn btn-danger w-100 mb-3 rounded-pill py-2" style="display:none;" onclick="stopCamera()">ปิดกล้อง</button>
            <canvas id="canvas"></canvas>
            <button id="scanBtn" class="btn btn-action w-100 mb-3 rounded-pill" onclick="startCamera()"><i class="bi bi-camera me-1"></i> เปิดกล้องสแกน</button>
            <div class="input-group-custom">
              <input type="text" id="recordId" placeholder="รหัสพนักงาน" autocomplete="off">
              <button id="recSubBtn" class="btn-action bg-dark" onclick="submitRecord()">บันทึก</button>
            </div>
          </div>
        </div>
      </div>

      <div class="tab-pane fade" id="tabMon">
        <div class="row row-cols-3 g-2 mt-3 mb-3" id="statGrid"></div>
        <div class="card main-card p-4">
          <div class="input-group-custom mb-3">
            <input type="text" id="monId" placeholder="รหัสพนักงาน" autocomplete="off">
            <button id="monBtn" class="btn-action" onclick="getMonitor()">ค้นหา</button>
          </div>
          <div id="monResult"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    let currentMode = null;
    let video = document.createElement("video");
    let canvas = document.getElementById("canvas").getContext("2d");
    let scanning = false;

    function setMode(mode) {
      currentMode = mode;
      const frame = document.getElementById('ui-frame');
      const bIn = document.getElementById('btn-checkin');
      const bOut = document.getElementById('btn-checkout');

      // ล้างคลาสสีเก่าทั้งหมด
      frame.classList.remove('border-blue', 'border-red');
      bIn.classList.remove('active-in');
      bOut.classList.remove('active-out');

      // ใส่สีตามโหมดที่เลือก
      if (mode === 'checkin') {
        frame.classList.add('border-blue');
        bIn.classList.add('active-in');
      } else if (mode === 'checkout') {
        frame.classList.add('border-red');
        bOut.classList.add('active-out');
      }

      document.getElementById('recordAction').classList.remove('locked');
      document.getElementById('recordId').focus();
    }

    // ฟังก์ชันอื่นๆ ยังคงเดิม
    async function callAPI(p,b){ const btn=document.getElementById(b); btn.disabled=true; let old=btn.innerHTML; btn.innerHTML='<span class="spinner-border spinner-border-sm"></span>'; try{ const res=await fetch(API_URL,{method:'POST',body:JSON.stringify(p)}); btn.disabled=false; btn.innerHTML=old; return await res.json(); }catch(e){ btn.disabled=false; btn.innerHTML=old; return null; } }
    async function submitRecord(){ let id=document.getElementById('recordId').value.trim(); if(!id||!currentMode)return; const r=await callAPI({action:'staffAction',id:id,type:currentMode},'recSubBtn'); Swal.fire({icon:r.success?'success':'error',title:r.msg,timer:1000,showConfirmButton:false}); document.getElementById('recordId').value=''; document.getElementById('recordId').focus(); }
    async function startCamera(){ try{ const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}}); scanning=true; video.srcObject=s; video.setAttribute("playsinline",true); video.play(); document.getElementById('canvas').style.display='block'; document.getElementById('scanBtn').style.display='none'; document.getElementById('stopBtn').style.display='block'; requestAnimationFrame(tick); }catch(e){}}
    function stopCamera(){ scanning=false; if(video.srcObject)video.srcObject.getTracks().forEach(t=>t.stop()); document.getElementById('canvas').style.display='none'; document.getElementById('scanBtn').style.display='block'; document.getElementById('stopBtn').style.display='none'; }
    function tick(){ if(video.readyState===video.HAVE_ENOUGH_DATA&&scanning){ let el=document.getElementById('canvas'); el.height=video.videoHeight; el.width=video.videoWidth; canvas.drawImage(video,0,0,el.width,el.height); let c=jsQR(canvas.getImageData(0,0,el.width,el.height).data,el.width,el.height); if(c){ document.getElementById('recordId').value=c.data; stopCamera(); submitRecord(); }} if(scanning)requestAnimationFrame(tick); }
    function resetAll(){ stopCamera(); document.getElementById('monResult').innerHTML=''; ['recordId','monId'].forEach(id=>document.getElementById(id).value=''); }
  </script>
</body>
</html>
