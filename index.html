<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>STAFF PORTAL - บันทึกเวลา</title>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&family=Inter:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <style>
    :root { --navy: #1a237e; --blue-light: #3b82f6; --bg-gray: #f4f7fe; }
    body { font-family: 'Kanit', sans-serif; background-color: var(--bg-gray); }
    .header-section { background: var(--navy); color: white; padding: 40px 0 70px 0; text-align: center; }
    
    .nav-container { margin-top: -35px; display: flex; justify-content: center; }
    .nav-pills { background: white; padding: 6px; border-radius: 50px; box-shadow: 0 10px 25px rgba(0,0,0,0.08); }
    .nav-pills .nav-link { border-radius: 40px; color: #666; padding: 10px 25px; font-weight: 600; border: none; }
    .nav-pills .nav-link.active { background-color: var(--navy) !important; color: white !important; }

    .main-card { border-radius: 30px; border: none; box-shadow: 0 15px 40px rgba(0,0,0,0.05); background: white; margin-top: 25px; }
    
    .mode-card { cursor: pointer; transition: 0.3s; border: 2px solid #edf2f7; border-radius: 20px; padding: 25px; background: white; }
    .mode-card.active-mode { border-color: var(--blue-light); background-color: #f0f7ff; transform: translateY(-3px); }
    .mode-card i { font-size: 2.5rem; color: var(--blue-light); }
    
    .input-group-custom { background: #fff; border: 1px solid #e2e8f0; border-radius: 18px; padding: 5px 5px 5px 20px; display: flex; align-items: center; }
    .input-group-custom input { border: none; outline: none; width: 100%; font-size: 1.1rem; }
    .btn-action { background: var(--blue-light); color: white; border-radius: 15px; padding: 12px 28px; border: none; font-weight: 600; }
    
    #canvas { width: 100%; border-radius: 20px; display: none; background: #000; margin-bottom: 15px; }
    .locked { opacity: 0.3; pointer-events: none; filter: grayscale(1); }
  </style>
</head>
<body>

  <script>
    // ใช้ API_URL เดิมที่เชื่อมกับ Google Sheets ของคุณ
    const API_URL = "https://script.google.com/macros/s/AKfycbyM1HtJEAG3qSCHPiX4diy9D_fZRjUa6dCcFgZCWa0j3qRLNJvu4nalzPgkDJANzoNn/exec";
  </script>

  <div class="header-section">
    <h2 class="fw-bold">STAFF PORTAL</h2>
    <p>ระบบบันทึกเวลาและแก้ไขข้อมูลพนักงาน</p>
  </div>

  <div class="container">
    <div class="nav-container">
      <ul class="nav nav-pills">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#recordTab" onclick="resetAll()"><i class="bi bi-qr-code-scan me-2"></i>บันทึกเวลา</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#editTab" onclick="resetEdit()"><i class="bi bi-pencil-square me-2"></i>แก้ไขข้อมูล</button></li>
      </ul>
    </div>

    <div class="tab-content pb-5">
      <div class="tab-pane fade show active" id="recordTab">
        <div class="card main-card p-4">
          <div class="row g-3 mb-4 text-center">
            <div class="col-6">
              <div id="btnIn" class="mode-card" onclick="setMode('checkin')">
                <i class="bi bi-box-arrow-in-right"></i>
                <div class="mt-2 fw-bold">CHECK-IN</div>
              </div>
            </div>
            <div class="col-6">
              <div id="btnOut" class="mode-card" onclick="setMode('checkout')">
                <i class="bi bi-box-arrow-left"></i>
                <div class="mt-2 fw-bold">CHECK-OUT</div>
              </div>
            </div>
          </div>

          <div id="recordAction" class="locked text-center">
            <canvas id="canvas"></canvas>
            <button id="scanBtn" class="btn btn-action w-100 mb-2" onclick="startCamera()">เปิดกล้องสแกน QR</button>
            <button id="stopBtn" class="btn btn-danger w-100 mb-3 rounded-4" style="display:none;" onclick="stopCamera()">ปิดกล้อง</button>
            
            <div class="input-group-custom">
              <input type="text" id="recordId" placeholder="กรอกรหัสพนักงาน" autocomplete="off" spellcheck="false">
              <button id="recordSubmitBtn" class="btn-action bg-dark" onclick="submitRecord()">บันทึก</button>
            </div>
          </div>
        </div>
      </div>

      <div class="tab-pane fade" id="editTab">
        <div class="card main-card p-4">
          <div id="searchBox" class="input-group-custom mb-3">
            <input type="text" id="editId" placeholder="ค้นหารหัสพนักงานเพื่อแก้ไข" autocomplete="off" spellcheck="false">
            <button id="editSearchBtn" class="btn-action" onclick="searchUser()">ค้นหา</button>
          </div>

          <div id="editForm" class="d-none">
            <input type="hidden" id="rowNum">
            <div class="mb-3">
              <label class="small text-muted mb-1">ชื่อ-นามสกุล</label>
              <input type="text" id="nameBox" class="form-control rounded-3 border-0 bg-light p-3" autocomplete="off">
            </div>
            <div class="row mb-3">
              <div class="col-6">
                <label class="small text-muted mb-1">แผนก</label>
                <input type="text" id="deptBox" class="form-control rounded-3 border-0 bg-light p-3" autocomplete="off">
              </div>
              <div class="col-6">
                <label class="small text-muted mb-1">ฝ่าย</label>
                <input type="text" id="sectBox" class="form-control rounded-3 border-0 bg-light p-3" autocomplete="off">
              </div>
            </div>
            <div class="mb-4">
              <label class="small text-muted mb-1">อีเมล</label>
              <input type="email" id="emailBox" class="form-control rounded-3 border-0 bg-light p-3" autocomplete="off">
            </div>
            <button id="editSaveBtn" class="btn btn-action w-100 py-3" onclick="saveEdit()">บันทึกข้อมูลทั้งหมด</button>
            <button class="btn btn-link w-100 text-muted mt-2" onclick="resetEdit()">ยกเลิก (ESC)</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    let video = document.createElement("video");
    let canvas = document.getElementById("canvas").getContext("2d");
    let currentMode = null, scanning = false;

    // ระบบ Keyboard (Enter / Esc)
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        const active = document.querySelector('.tab-pane.active').id;
        if (active === 'recordTab') submitRecord();
        if (active === 'editTab') document.getElementById('editForm').classList.contains('d-none') ? searchUser() : saveEdit();
      }
      if (e.key === 'Escape') resetAll();
    });

    function setMode(mode) {
      currentMode = mode;
      document.getElementById('btnIn').className = 'mode-card' + (mode==='checkin'?' active-mode':'');
      document.getElementById('btnOut').className = 'mode-card' + (mode==='checkout'?' active-mode':'');
      document.getElementById('recordAction').classList.remove('locked');
      document.getElementById('recordId').focus();
    }

    async function startCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        scanning = true; video.srcObject = stream; video.setAttribute("playsinline", true); video.play();
        document.getElementById('canvas').style.display = 'block';
        document.getElementById('scanBtn').style.display = 'none';
        document.getElementById('stopBtn').style.display = 'block';
        requestAnimationFrame(tick);
      } catch (e) { Swal.fire('Error', 'ไม่สามารถเข้าถึงกล้องได้', 'error'); }
    }

    function stopCamera() {
      scanning = false; if (video.srcObject) video.srcObject.getTracks().forEach(t => t.stop());
      document.getElementById('canvas').style.display = 'none';
      document.getElementById('scanBtn').style.display = 'block';
      document.getElementById('stopBtn').style.display = 'none';
    }

    function tick() {
      if (video.readyState === video.HAVE_ENOUGH_DATA && scanning) {
        let el = document.getElementById('canvas');
        el.height = video.videoHeight; el.width = video.videoWidth;
        canvas.drawImage(video, 0, 0, el.width, el.height);
        let code = jsQR(canvas.getImageData(0, 0, el.width, el.height).data, el.width, el.height);
        if (code) { document.getElementById('recordId').value = code.data; stopCamera(); submitRecord(); }
      }
      if (scanning) requestAnimationFrame(tick);
    }

    async function submitRecord() {
      let id = document.getElementById('recordId').value.trim();
      if (!id || !currentMode) return;
      Swal.fire({ title: 'กำลังบันทึก...', didOpen: () => Swal.showLoading() });
      const r = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'staffAction', id: id, type: currentMode }) }).then(res => res.json());
      Swal.fire({ icon: r.success ? 'success' : 'error', title: r.msg, timer: 2000, showConfirmButton: false });
      document.getElementById('recordId').value = '';
      document.getElementById('recordId').focus();
    }

    async function searchUser() {
      let id = document.getElementById('editId').value.trim();
      if(!id) return;
      const r = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'searchUser', id: id }) }).then(res => res.json());
      if (r) {
        document.getElementById('rowNum').value = r.row;
        document.getElementById('nameBox').value = r.name;
        document.getElementById('deptBox').value = r.dept;
        document.getElementById('sectBox').value = r.sect;
        document.getElementById('emailBox').value = r.email;
        document.getElementById('searchBox').classList.add('d-none');
        document.getElementById('editForm').classList.remove('d-none');
      } else { Swal.fire('ไม่พบรหัสพนักงาน', '', 'warning'); }
    }

    async function saveEdit() {
      const d = { 
        row: document.getElementById('rowNum').value, 
        name: document.getElementById('nameBox').value, 
        dept: document.getElementById('deptBox').value, 
        sect: document.getElementById('sectBox').value,
        email: document.getElementById('emailBox').value 
      };
      const r = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'updateUser', formData: d }) }).then(res => res.json());
      if (r.success) { Swal.fire('สำเร็จ', 'บันทึกข้อมูลเรียบร้อย', 'success'); resetEdit(); }
    }

    function resetEdit() {
      document.getElementById('searchBox').classList.remove('d-none');
      document.getElementById('editForm').classList.add('d-none');
      document.getElementById('editId').value = '';
      document.getElementById('editId').focus();
    }

    function resetAll() {
      stopCamera();
      document.getElementById('recordId').value = '';
      document.getElementById('editId').value = '';
      const active = document.querySelector('.tab-pane.active').id;
      if(active === 'recordTab' && currentMode) document.getElementById('recordId').focus();
    }
  </script>
</body>
</html>
