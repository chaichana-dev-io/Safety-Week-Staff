<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>STAFF PORTAL 2026</title>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&family=Inter:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <style>
    :root { --navy: #1a237e; --blue-light: #3b82f6; --red-out: #dc3545; --bg-gray: #f4f7fe; }
    body { font-family: 'Kanit', sans-serif; background-color: var(--bg-gray); overflow-x: hidden; }
    
    .header-section { background: var(--navy); color: white; padding: 30px 0 70px 0; text-align: center; }
    
    /* จัดเมนูกลุ่มใหญ่ไวตรงกลาง */
    .nav-container { 
      margin-top: -40px; 
      display: flex; 
      justify-content: center; /* จัดกลุ่มปุ่มไว้กลางจอ */
      padding: 0 15px; 
    }
    
    .nav-pills { 
      background: white; 
      padding: 5px; 
      border-radius: 50px; 
      box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
      display: flex; 
      flex-wrap: nowrap; 
      width: 100%; 
      max-width: 450px; 
      justify-content: center; /* จัดปุ่มภายในให้อยู่กลาง */
    }

    .nav-pills .nav-item { flex: 1; }

    /* จัดเนื้อหาภายในปุ่ม (Icon + Text) ให้ตรงกลางเป๊ะ */
    .nav-pills .nav-link { 
      border-radius: 40px; 
      color: #666; 
      padding: 10px 5px; 
      font-weight: 600; 
      font-size: 0.85rem; 
      border: none; 
      display: flex;
      flex-direction: column; /* Icon บน Text ล่าง */
      align-items: center;    /* จัดกลางแนวตั้ง */
      justify-content: center;/* จัดกลางแนวนอน */
      white-space: nowrap; 
      transition: 0.3s;
      background: transparent;
      width: 100%;
    }
    
    .nav-pills .nav-link i { font-size: 1.2rem; margin-bottom: 2px; }
    .nav-pills .nav-link.active { background-color: var(--navy) !important; color: white !important; }

    /* UI อื่นๆ */
    .main-card { border-radius: 30px; border: 4px solid transparent; box-shadow: 0 15px 40px rgba(0,0,0,0.05); background: white; margin-top: 25px; }
    .card-checkin { border-color: var(--blue-light) !important; }
    .card-checkout { border-color: var(--red-out) !important; }
    .mode-card { cursor: pointer; transition: 0.2s; border: 2px solid #edf2f7; border-radius: 20px; background: white; text-align: center; }
    .active-checkin { border-color: var(--blue-light) !important; background-color: #f0f7ff !important; }
    .active-checkout { border-color: var(--red-out) !important; background-color: #fff5f5 !important; }
    .input-group-custom { background: #fff; border: 1px solid #e2e8f0; border-radius: 20px; padding: 5px 5px 5px 20px; display: flex; align-items: center; }
    .input-group-custom input { border: none; outline: none; width: 100%; font-size: 1.1rem; }
    .btn-action { background: var(--blue-light); color: white; border-radius: 15px; padding: 12px 25px; border: none; font-weight: 600; }
    .stat-box { background: white; border-radius: 20px; padding: 12px; border: 1px solid #edf2f7; text-align: center; }
    .stat-value { font-size: 1.4rem; font-weight: 700; color: var(--navy); }
    .progress-circle { width: 100px; height: 100px; border-radius: 50%; background: conic-gradient(var(--blue-light) var(--p), #edf2f7 0); display: flex; align-items: center; justify-content: center; margin: 15px auto; position: relative; }
    .progress-circle::before { content: ""; position: absolute; width: 85px; height: 85px; background: white; border-radius: 50%; }
    #canvas { width: 100%; border-radius: 20px; display: none; background: #000; margin-bottom: 10px; }
    .locked { opacity: 0.3; pointer-events: none; filter: grayscale(1); }
  </style>
</head>
<body>

  <script>const API_URL = "https://script.google.com/macros/s/AKfycbyM1HtJEAG3qSCHPiX4diy9D_fZRjUa6dCcFgZCWa0j3qRLNJvu4nalzPgkDJANzoNn/exec";</script>

  <div class="header-section">
    <h3 class="fw-bold">STAFF PORTAL</h3>
    <p class="small opacity-75">Safety Week 2026</p>
  </div>

  <div class="container">
    <div class="nav-container">
      <ul class="nav nav-pills" id="staffTabs">
        <li class="nav-item">
          <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tabRec" onclick="resetAll()">
            <i class="bi bi-qr-code-scan"></i><span>บันทึก</span>
          </button>
        </li>
        <li class="nav-item">
          <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tabMon" onclick="updateStats(); resetAll();">
            <i class="bi bi-grid-3x3-gap"></i><span>Monitor</span>
          </button>
        </li>
        <li class="nav-item">
          <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tabEdit" onclick="resetEdit(); resetAll();">
            <i class="bi bi-pencil-square"></i><span>แก้ไข</span>
          </button>
        </li>
      </ul>
    </div>

    <div class="tab-content pb-5">
      <div class="tab-pane fade show active" id="tabRec">
        <div class="card main-card p-4" id="recordCard">
          <div class="row g-2 mb-4">
            <div class="col-6"><div id="btnIn" class="mode-card p-3" onclick="setMode('checkin')"><i class="bi bi-box-arrow-in-right fs-2 text-primary"></i><div class="mt-1 fw-bold small">CHECK-IN</div></div></div>
            <div class="col-6"><div id="btnOut" class="mode-card p-3" onclick="setMode('checkout')"><i class="bi bi-box-arrow-left fs-2 text-danger"></i><div class="mt-1 fw-bold small">CHECK-OUT</div></div></div>
          </div>
          <div id="recordAction" class="locked text-center">
            <button id="stopBtn" class="btn btn-danger w-100 mb-3 rounded-pill py-2" style="display:none;" onclick="stopCamera()">ปิดกล้อง</button>
            <canvas id="canvas"></canvas>
            <button id="scanBtn" class="btn btn-action w-100 mb-3 rounded-pill" onclick="startCamera()"><i class="bi bi-camera me-1"></i> เปิดกล้องสแกน</button>
            <div class="input-group-custom">
              <input type="text" id="recordId" placeholder="รหัสพนักงาน" autocomplete="off">
              <button id="recSubBtn" class="btn-action bg-dark" onclick="submitRecord()">บันทึก</button>
            </div>
          </div>
        </div>
      </div>

      <div class="tab-pane fade" id="tabMon">
        <div class="row row-cols-3 g-2 mt-3 mb-3" id="statGrid"></div>
        <div class="card main-card p-4">
          <div class="input-group-custom mb-3">
            <input type="text" id="monId" placeholder="รหัสพนักงาน" autocomplete="off">
            <button id="monBtn" class="btn-action" onclick="getMonitor()">ค้นหา</button>
          </div>
          <div id="monResult"></div>
        </div>
      </div>

      <div class="tab-pane fade" id="tabEdit">
        <div class="card main-card p-4">
          <div id="searchBox" class="input-group-custom mb-3">
            <input type="text" id="editId" placeholder="ค้นหารหัสพนักงาน" autocomplete="off">
            <button id="editSearchBtn" class="btn-action" onclick="searchUser()">ค้นหา</button>
          </div>
          <div id="editForm" class="d-none">
            <input type="hidden" id="rowNum"><div class="mb-2"><label class="small text-muted">ชื่อ-นามสกุล</label><input type="text" id="nameBox" class="form-control rounded-3 border-0 bg-light p-3"></div>
            <div class="row g-2 mb-2"><div class="col-6"><label class="small text-muted">แผนก</label><input type="text" id="deptBox" class="form-control rounded-3 border-0 bg-light p-3"></div><div class="col-6"><label class="small text-muted">ฝ่าย</label><input type="text" id="sectBox" class="form-control rounded-3 border-0 bg-light p-3"></div></div>
            <div class="mb-4"><label class="small text-muted">อีเมล</label><input type="email" id="emailBox" class="form-control rounded-3 border-0 bg-light p-3"></div>
            <button id="editSaveBtn" class="btn btn-action w-100 py-3" onclick="saveEdit()">บันทึกข้อมูล</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="infoModal" tabindex="-1" aria-hidden="true"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-body p-5 text-center" id="modalContent"></div></div></div></div>

  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Logic ทั้งหมด (callAPI, setMode, submitRecord, getMonitor, ฯลฯ) คงเดิมเหมือนเวอร์ชันที่แล้ว
    let video = document.createElement("video"), canvas = document.getElementById("canvas").getContext("2d"), currentMode = null, scanning = false, infoModal = new bootstrap.Modal(document.getElementById('infoModal'));
    function setMode(m){ currentMode=m; document.getElementById('recordCard').className='card main-card p-4 '+(m==='checkin'?'card-checkin':'card-checkout'); document.getElementById('btnIn').className='mode-card p-3 '+(m==='checkin'?'active-checkin':''); document.getElementById('btnOut').className='mode-card p-3 '+(m==='checkout'?'active-checkout':''); document.getElementById('recordAction').classList.remove('locked'); document.getElementById('recordId').focus(); }
    async function callAPI(p,b){ const btn=document.getElementById(b); btn.disabled=true; let old=btn.innerHTML; btn.innerHTML='<span class="spinner-border spinner-border-sm"></span>'; try{ const res=await fetch(API_URL,{method:'POST',body:JSON.stringify(p)}); btn.disabled=false; btn.innerHTML=old; return await res.json(); }catch(e){ btn.disabled=false; btn.innerHTML=old; return null; } }
    async function submitRecord(){ let id=document.getElementById('recordId').value.trim(); if(!id||!currentMode)return; const r=await callAPI({action:'staffAction',id:id,type:currentMode},'recSubBtn'); Swal.fire({icon:r.success?'success':'error',title:r.msg,timer:1000,showConfirmButton:false}); document.getElementById('recordId').value=''; document.getElementById('recordId').focus(); }
    async function startCamera(){ try{ const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}}); scanning=true; video.srcObject=s; video.setAttribute("playsinline",true); video.play(); document.getElementById('canvas').style.display='block'; document.getElementById('scanBtn').style.display='none'; document.getElementById('stopBtn').style.display='block'; requestAnimationFrame(tick); }catch(e){}}
    function stopCamera(){ scanning=false; if(video.srcObject)video.srcObject.getTracks().forEach(t=>t.stop()); document.getElementById('canvas').style.display='none'; document.getElementById('scanBtn').style.display='block'; document.getElementById('stopBtn').style.display='none'; }
    function tick(){ if(video.readyState===video.HAVE_ENOUGH_DATA&&scanning){ let el=document.getElementById('canvas'); el.height=video.videoHeight; el.width=video.videoWidth; canvas.drawImage(video,0,0,el.width,el.height); let c=jsQR(canvas.getImageData(0,0,el.width,el.height).data,el.width,el.height); if(c){ document.getElementById('recordId').value=c.data; stopCamera(); submitRecord(); }} if(scanning)requestAnimationFrame(tick); }
    async function getMonitor(tid=null){ let id=tid||document.getElementById('monId').value.trim(); if(!id)return; const r=await callAPI({action:'monitor',id:id},'monBtn'); if(!r)return; if(r.type==='AAA'){ let h='<table class="table small table-aaa"><tbody>'+r.list.map(p=>`<tr onclick="getMonitor('${p.id}')"><td>${p.name}<br><small>${p.id}</small></td><td class="text-end fw-bold text-primary">${p.progress}/9</td></tr>`).join('')+'</tbody></table>'; document.getElementById('monResult').innerHTML=h; }else{ let h=`<div class="text-center"><h4 class="fw-bold mb-4">${r.name}</h4><div class="progress-circle" style="--p:${Math.round(r.progress/r.total*100)}%"><div class="progress-text">${r.progress}/${r.total}</div></div><div class="badge bg-light text-success p-2 px-4 mt-2">สถานีถัดไป: ${r.nextBase}</div></div>`; if(tid){document.getElementById('modalContent').innerHTML=h; infoModal.show();}else{document.getElementById('monResult').innerHTML=h;} } document.getElementById('monId').value=''; }
    async function updateStats(){ const res=await fetch(`${API_URL}?action=getStats`); const s=await res.json(); let h=''; for(let i=1;i<=9;i++)h+=`<div class="col"><div class="stat-box"><div style="font-size:0.7rem;" class="text-muted">ฐาน ${i}</div><div class="stat-value">${s["Base"+i]||0}</div></div></div>`; document.getElementById('statGrid').innerHTML=h; }
    async function searchUser(){ const r=await callAPI({action:'searchUser',id:document.getElementById('editId').value},'editSearchBtn'); if(r){ ['rowNum','nameBox','deptBox','sectBox','emailBox'].forEach((k,i)=>document.getElementById(k).value=Object.values(r)[i]); document.getElementById('searchBox').classList.add('d-none'); document.getElementById('editForm').classList.remove('d-none'); } document.getElementById('editId').value=''; }
    async function saveEdit(){ const d={row:document.getElementById('rowNum').value,name:document.getElementById('nameBox').value,dept:document.getElementById('deptBox').value,sect:document.getElementById('sectBox').value,email:document.getElementById('emailBox').value}; const r=await callAPI({action:'updateUser',formData:d},'editSaveBtn'); if(r.success){Swal.fire({icon:'success',title:'สำเร็จ',timer:1000,showConfirmButton:false}); resetEdit();} }
    function resetEdit(){ document.getElementById('searchBox').classList.remove('d-none'); document.getElementById('editForm').classList.add('d-none'); document.getElementById('editId').value=''; }
    function resetAll(){ stopCamera(); document.getElementById('monResult').innerHTML=''; ['recordId','monId','editId'].forEach(id=>document.getElementById(id).value=''); }
  </script>
</body>
</html>
