<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>STAFF SYSTEM 2026</title>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <style>
    :root { --navy: #1a237e; --blue: #3b82f6; --red: #dc3545; --bg: #f4f7fe; }
    body { font-family: 'Kanit', sans-serif; background: var(--bg); overflow-x: hidden; }
    .header-section { background: var(--navy); color: white; padding: 40px 0 80px; text-align: center; }
    .nav-container { margin-top: -50px; display: flex; justify-content: center; }
    .nav-pills { background: white; padding: 6px; border-radius: 50px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); display: inline-flex; }
    .nav-link { border-radius: 50px !important; color: #666; font-weight: 600; padding: 10px 22px; border: none; transition: 0.3s; margin: 0 2px; }
    .nav-link.active { background-color: var(--navy) !important; color: white !important; }
    .main-card { border-radius: 30px; border: none; box-shadow: 0 15px 40px rgba(0,0,0,0.05); background: white; margin-top: 25px; }
    .input-custom { background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 20px; padding: 15px 25px; font-size: 1.2rem; width: 100%; transition: 0.3s; }
    .input-custom:focus { border-color: var(--blue); outline: none; background: white; }
    .btn-action { border-radius: 20px; padding: 15px; font-weight: 600; transition: 0.2s; border: none; width: 100%; }
    .stat-box { min-height: 100px; display: flex; flex-direction: column; justify-content: center; border: 1px solid #eee; transition: 0.3s; background: white; border-radius: 20px !important; }
    .progress { height: 10px; border-radius: 10px; background-color: #e9ecef; }
    #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.7); display: none; justify-content: center; align-items: center; z-index: 9999; }
  </style>
</head>
<body>

<div id="loadingOverlay"><div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div></div>

<div class="header-section">
  <h2 class="fw-bold">STAFF SYSTEM</h2>
  <p class="opacity-75">Safety Week Activity 2026</p>
</div>

<div class="container mb-5">
  <div class="nav-container">
    <ul class="nav nav-pills" id="mainTabs">
      <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tabRec" onclick="resetAll()"><i class="bi bi-qr-code-scan"></i> บันทึก</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tabEdit" onclick="resetEdit()"><i class="bi bi-pencil-square"></i> แก้ไข</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tabMon" onclick="updateStats()"><i class="bi bi-grid"></i> Monitor</button></li>
    </ul>
  </div>

  <div class="tab-content">
    <div class="tab-pane fade show active" id="tabRec">
      <div class="card main-card p-4">
        <div class="row g-3 mb-4 text-center">
          <div class="col-6"><div id="btnIn" class="mode-card p-3 border rounded-4" style="cursor:pointer" onclick="setMode('checkin')"><i class="bi bi-box-arrow-in-right fs-1 text-primary"></i><div class="fw-bold mt-2">CHECK-IN</div></div></div>
          <div class="col-6"><div id="btnOut" class="mode-card p-3 border rounded-4" style="cursor:pointer" onclick="setMode('checkout')"><i class="bi bi-box-arrow-left fs-1 text-danger"></i><div class="fw-bold mt-2">CHECK-OUT</div></div></div>
        </div>
        <div id="actionArea" class="d-none">
          <input type="text" id="recordId" class="input-custom mb-3" placeholder="กรอกรหัส หรือ สแกน QR" autocomplete="off">
          <button class="btn btn-primary btn-action" onclick="submitRecord()">ยืนยันบันทึก (Enter)</button>
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="tabEdit">
      <div class="card main-card p-4">
        <div id="editSearchArea">
          <input type="text" id="editId" class="input-custom mb-3" placeholder="กรอกรหัสพนักงานที่ต้องการแก้ไข" autocomplete="off">
          <button class="btn btn-primary btn-action" onclick="searchUser()">ค้นหา (Enter)</button>
        </div>
        <div id="editForm" class="d-none">
          <h5 class="fw-bold mb-3 text-primary">แก้ไขข้อมูลพนักงาน</h5>
          <div class="mb-3"><label class="small text-muted">ชื่อ-นามสกุล</label><input type="text" id="nameBox" class="form-control p-3 rounded-4 border-2" autocomplete="off"></div>
          <div class="row g-2 mb-3">
            <div class="col-6"><label class="small text-muted">แผนก</label><input type="text" id="deptBox" class="form-control p-3 rounded-4 border-2" autocomplete="off"></div>
            <div class="col-6"><label class="small text-muted">ฝ่าย</label><input type="text" id="sectBox" class="form-control p-3 rounded-4 border-2" autocomplete="off"></div>
          </div>
          <div class="mb-4"><label class="small text-muted">อีเมล</label><input type="email" id="emailBox" class="form-control p-3 rounded-4 border-2" autocomplete="off"></div>
          <div class="row g-2">
            <div class="col-6"><button class="btn btn-light btn-action" onclick="resetEdit()">ยกเลิก (ESC)</button></div>
            <div class="col-6"><button class="btn btn-primary btn-action" onclick="saveEdit()">บันทึกข้อมูล (Enter)</button></div>
          </div>
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="tabMon">
      <div class="text-center mt-4">
        <h6 class="fw-bold text-navy mb-3"><i class="bi bi-people-fill"></i> จำนวนสมาชิกแยกตามกลุ่ม (Group 1-9)</h6>
      </div>
      <div class="row row-cols-3 g-2" id="statGrid"></div>
      
      <hr class="my-4 opacity-25">

      <div class="card main-card p-4 text-center">
        <h6 class="fw-bold mb-3 text-muted">กรอกรหัสพนักงาน</h6>
        <div class="d-flex gap-2 mb-3">
          <input type="text" id="monId" class="input-custom" placeholder="รหัสพนักงาน หรือ AAA" autocomplete="off">
          <button class="btn btn-outline-secondary rounded-4 px-3" onclick="clearMon()"><i class="bi bi-x-lg"></i></button>
        </div>
        <button class="btn btn-primary btn-action" onclick="getMonitor()">ค้นหาข้อมูล (Enter)</button>
        <div id="monResult" class="mt-3"></div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxDRFP0K4rpXrEIkiFqlL3Zf2_WGGOAF2X1OPLl07hql-dRBq5mnUN_Hn-cB-OdyGOo9g/exec";

const showLoad = (show) => document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
const formatID = (id) => {
  let s = id.toString().trim();
  if (/^\d+$/.test(s) && s.length <= 6) return s.padStart(6, '0');
  return s.toUpperCase();
};

function setMode(m) {
  currentMode = m;
  document.getElementById('actionArea').classList.remove('d-none');
  document.getElementById('recordId').focus();
}

// --- ฟังก์ชัน Monitor หลัก (รองรับ AAA) ---
async function getMonitor() {
  let rawVal = document.getElementById('monId').value.trim();
  if (!rawVal) return;
  const resultDiv = document.getElementById('monResult');
  
  // โหมด AAA
  if (rawVal.toUpperCase() === 'AAA') {
    showLoad(true);
    try {
      const res = await fetch(`${API_URL}?action=getAllProgress`);
      const r = await res.json();
      showLoad(false);
      if (r.success) {
        let h = `<div class="table-responsive mt-3"><table class="table table-sm table-hover border" style="font-size:0.75rem"><thead class="table-light"><tr><th>ชื่อ</th><th class="text-center">ฐาน</th></tr></thead><tbody>`;
        r.data.forEach(p => {
          h += `<tr><td class="text-start">${p.name}</td><td><div class="progress" style="height:8px"><div class="progress-bar ${p.pass >= 9 ? 'bg-success':'bg-primary'}" style="width:${(p.pass/9)*100}%"></div></div><div class="text-end" style="font-size:0.6rem">${p.pass}/9</div></td></tr>`;
        });
        h += `</tbody></table></div>`;
        resultDiv.innerHTML = h;
      }
    } catch (e) { showLoad(false); resultDiv.innerHTML = 'Error AAA'; }
    return;
  }

  // โหมดรายคน
  const id = formatID(rawVal);
  showLoad(true);
  try {
    const res = await fetch(`${API_URL}?action=searchUser&query=${encodeURIComponent(id)}`);
    const r = await res.json();
    showLoad(false);
    if (r.success) {
      resultDiv.innerHTML = `
        <div class="p-3 bg-light rounded-4 mt-3 text-start border shadow-sm">
          <div class="d-flex justify-content-between align-items-center"><strong>${r.name}</strong><span class="badge bg-navy">${r.group}</span></div>
          <div class="progress my-2"><div class="progress-bar" style="width:${(r.passedCount/9)*100}%"></div></div>
          <div class="text-end small">ผ่านแล้ว ${r.passedCount}/9 ฐาน</div>
        </div>`;
    } else { resultDiv.innerHTML = '<div class="text-danger">ไม่พบข้อมูล</div>'; }
  } catch (e) { showLoad(false); }
}

async function updateStats() {
  const grid = document.getElementById('statGrid');
  try {
    const res = await fetch(`${API_URL}?action=getBaseMonitor`);
    const r = await res.json();
    if (r.success) {
      grid.innerHTML = r.data.map(item => `
        <div class="col"><div class="stat-box shadow-sm border text-center" style="border-top: 4px solid var(--navy) !important">
          <div class="small fw-bold text-muted">${item.baseName}</div>
          <div class="fs-2 fw-bold text-primary">${item.passed}</div>
          <div style="font-size:0.6rem" class="text-muted">คน</div>
        </div></div>`).join('');
    }
  } catch (e) {}
}

function clearMon() {
  document.getElementById('monId').value = '';
  document.getElementById('monResult').innerHTML = '';
  updateStats();
}

function resetEdit() {
  document.getElementById('editSearchArea').classList.remove('d-none');
  document.getElementById('editForm').classList.add('d-none');
  document.getElementById('editId').value = '';
  ['nameBox','deptBox','sectBox','emailBox'].forEach(id => document.getElementById(id).value = '');
}

// --- Auto Refresh ทุก 1 นาที ---
setInterval(() => {
  if (document.querySelector('#tabMon.active')) {
    updateStats();
    if (document.getElementById('monId').value.toUpperCase() === 'AAA') getMonitor();
  }
}, 60000);

// Key Events
document.addEventListener('keydown', (e) => {
  const activeTab = document.querySelector('.tab-pane.active').id;
  if (e.key === 'Enter') {
    if (activeTab === 'tabMon') getMonitor();
    if (activeTab === 'tabEdit') (document.getElementById('editForm').classList.contains('d-none')) ? searchUser() : saveEdit();
  }
  if (e.key === 'Escape') {
    if (activeTab === 'tabMon') clearMon();
    if (activeTab === 'tabEdit') resetEdit();
  }
});

window.onload = updateStats;
</script>
</body>
</html>
